<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Clojure--testing-the-creation-of-a-partial-function by jaycfields</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Clojure--testing-the-creation-of-a-partial-function</h1>
        <p></p>

        <p class="view"><a href="https://github.com/jaycfields/Clojure--Testing-The-Creation-Of-A-Partial-Function">View the Project on GitHub <small>jaycfields/Clojure--Testing-The-Creation-Of-A-Partial-Function</small></a></p>


        <ul>
          <li><a href="https://github.com/jaycfields/Clojure--Testing-The-Creation-Of-A-Partial-Function/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/jaycfields/Clojure--Testing-The-Creation-Of-A-Partial-Function/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/jaycfields/Clojure--Testing-The-Creation-Of-A-Partial-Function">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
I recently refactored some code that takes longs from two different sources to compute one value. The code originally stored the longs and called a function when all of the data arrived. The refactored version partials the data while it's incomplete and executes the partial'd function when all of the data is available. Below is a contrived example of what I'm taking about.
<br><br>
Let's pretend we need a function that will allow us to check whether or not another drink would make us legally drunk in New York City.
<br><br>
The code below stores the current bac and uses the value when legally-drunk? is called.
<br><br>
<script src="http://gist-it.appspot.com/github/jaycfields/Clojure--Testing-The-Creation-Of-A-Partial-Function/blob/master/src/clojure/original.clj"></script>
The following (passing) tests demonstrate that everything works as expected.
<br><br>
<script src="http://gist-it.appspot.com/github/jaycfields/Clojure--Testing-The-Creation-Of-A-Partial-Function/blob/master/test/expectations/original_expectations.clj"></script>
This code works without issue, but can also be refactored to store a partial'd function instead of the bac value. Why you would want to do such a thing is outside of the scope of this post, so we'll just assume this is a good refactoring. The code below no longer stores the bac value, and instead stores the pure-legally-drunk? function partial'd with the bac value.
<br><br>
<script src="http://gist-it.appspot.com/github/jaycfields/Clojure--Testing-The-Creation-Of-A-Partial-Function/blob/master/src/clojure/refactored.clj"></script>
Two of the three of the tests don't change; however, the test that was verifying the state is now broken.
<br><br>
<script src="http://gist-it.appspot.com/github/jaycfields/Clojure--Testing-The-Creation-Of-A-Partial-Function/blob/master/test/expectations/refactored_expectations.clj"></script>
note: The test output has been trimmed and reformatted to avoid horizontal scrolling.
<br><br>
In the output you can see that the test is failing as you'd expect, due to the change in what we're storing. What's broken is obvious, but there's not an obvious solution. Assuming you still want this state based test, how do you verify that you've partial'd the right function with the right value?
<br><br>
The solution is simple, but a bit tricky. As long as you don't find the redef too magical, the following solution allows you to easily verify the function that's being partial'd as well as the arguments.
<br><br>
<script src="http://gist-it.appspot.com/github/jaycfields/Clojure--Testing-The-Creation-Of-A-Partial-Function/blob/master/test/expectations/refactored_passing_expectations.clj"></script>
Those tests all pass, and should provide security that the legally-drunk? and update-bac functions are sufficiently tested. The pure-legally-drunk? function still needs to be tested, but that should be easy since it's a pure function.
       
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/jaycfields">jaycfields</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>
